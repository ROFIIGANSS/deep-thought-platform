global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    retries 3

# HAProxy Stats Page
frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /
    stats refresh 10s
    stats show-legends
    stats show-node

# Frontend for MCP Router (gRPC)
frontend mcp_router_frontend
    bind *:50051
    mode tcp
    option tcplog
    default_backend mcp_router_backend

# Frontend for MCP Server (HTTP/SSE for Cursor)
frontend mcp_server_frontend
    bind *:3000
    mode http
    option httplog
    default_backend mcp_server_backend

# Frontend for Catalog API (HTTP)
frontend catalog_api_frontend
    bind *:8000
    mode http
    option httplog
    default_backend catalog_api_backend

# Frontend for Catalog UI (HTTP)
frontend catalog_ui_frontend
    bind *:8080
    mode http
    option httplog
    default_backend catalog_ui_backend

# DNS Resolvers for Docker
resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold other 10s
    hold refused 10s
    hold nx 10s
    hold timeout 10s
    hold valid 10s
    hold obsolete 10s

# Backend for MCP Router with Docker Compose service discovery
backend mcp_router_backend
    mode tcp
    balance roundrobin
    option tcp-check
    
    # Dynamic backend servers for Docker Compose scaled services
    # init-addr last: Try to resolve, fallback to last known address
    # resolvers docker: Use Docker's internal DNS
    server router1 agent-platform-server-mcp-router-1:50051 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server router2 agent-platform-server-mcp-router-2:50051 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server router3 agent-platform-server-mcp-router-3:50051 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server router4 agent-platform-server-mcp-router-4:50051 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server router5 agent-platform-server-mcp-router-5:50051 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server router6 agent-platform-server-mcp-router-6:50051 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server router7 agent-platform-server-mcp-router-7:50051 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server router8 agent-platform-server-mcp-router-8:50051 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server router9 agent-platform-server-mcp-router-9:50051 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server router10 agent-platform-server-mcp-router-10:50051 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker

# Backend for MCP Server (HTTP/SSE)
backend mcp_server_backend
    mode http
    balance source
    # Stick requests from the same client IP to the same backend instance
    stick-table type ip size 200k expire 30m
    stick on src
    option httpchk GET /sse
    http-check expect status 200
    
    # Dynamic backend servers for Docker Compose scaled services
    server mcp1 agent-platform-server-mcp-server-1:3000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server mcp2 agent-platform-server-mcp-server-2:3000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server mcp3 agent-platform-server-mcp-server-3:3000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server mcp4 agent-platform-server-mcp-server-4:3000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server mcp5 agent-platform-server-mcp-server-5:3000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server mcp6 agent-platform-server-mcp-server-6:3000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server mcp7 agent-platform-server-mcp-server-7:3000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server mcp8 agent-platform-server-mcp-server-8:3000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server mcp9 agent-platform-server-mcp-server-9:3000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server mcp10 agent-platform-server-mcp-server-10:3000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker

# Backend for Catalog API (HTTP)
backend catalog_api_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Dynamic backend servers for Docker Compose scaled services
    server catalog-api1 agent-platform-server-catalog-api-1:8000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server catalog-api2 agent-platform-server-catalog-api-2:8000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server catalog-api3 agent-platform-server-catalog-api-3:8000 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker

# Backend for Catalog UI (HTTP)
backend catalog_ui_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Dynamic backend servers for Docker Compose scaled services
    server catalog-ui1 agent-platform-server-catalog-ui-1:80 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server catalog-ui2 agent-platform-server-catalog-ui-2:80 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker
    server catalog-ui3 agent-platform-server-catalog-ui-3:80 check inter 2000 rise 2 fall 3 init-addr last,libc,none resolvers docker

